<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Canlƒ± Piyasalar ‚Äî D√∂viz ‚Ä¢ Altƒ±n ‚Ä¢ D√∂n√º≈üt√ºr√ºc√º</title>
  <meta name="description" content="Cloudflare Worker √ºzerinden Harem JSON verisiyle canlƒ± d√∂viz ve altƒ±n fiyatlarƒ± + d√∂n√º≈üt√ºr√ºc√º." />
  <style>
    :root{ --bg:#0b0c0f; --card:#12141a; --muted:#8b93a7; --fg:#e6e9f2; --brand:#f5bf3e; --border:#1f2430; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--fg);}
    .container{max-width:1000px; margin:0 auto; padding:24px;}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px}
    .title{display:flex; align-items:center; gap:12px}
    .logo{width:34px; height:34px; border-radius:10px; background:linear-gradient(135deg, #373b44, #0f0f10); position:relative; box-shadow:0 8px 24px #00000055}
    .logo::after{content:""; position:absolute; inset:6px; border-radius:8px; background:linear-gradient(135deg, #f7e08f, #caa33a);}
    h1{font-size:20px; margin:0} .sub{font-size:12px; color:var(--muted)}
    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    button{appearance:none; border:none; background:var(--card); color:var(--fg); padding:10px 12px; border-radius:12px; cursor:pointer; box-shadow:0 0 0 1px var(--border);}
    .brand{background:linear-gradient(135deg,#f5bf3e,#d09d16); color:#1a1205; font-weight:700;}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{appearance:none; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; background:#171a22; color:var(--fg); box-shadow:0 0 0 1px var(--border); font-weight:700}
    .tab.active{background:linear-gradient(135deg,#f5bf3e,#d09d16); color:#1a1205}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 40px #00000055; overflow:hidden}
    .meta{display:flex; gap:12px; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border)}
    .badge{font-size:12px; padding:6px 8px; border-radius:999px; background:#171a22; border:1px solid var(--border); color:var(--muted)}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{font-size:12px; color:var(--muted); text-align:left; padding:12px 14px; position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border);}
    tbody td{padding:14px; border-bottom:1px solid var(--border);} tbody tr:hover{background:#141821}
    .name{font-weight:600} .unit{color:var(--muted); font-size:12px} .money{font-variant-numeric: tabular-nums; text-align:right}
    .footer{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; font-size:12px; color:var(--muted)}
    .link{color:var(--fg); opacity:.8} .link:hover{opacity:1}
    .hide{display:none !important}
    /* Converter */
    .conv{padding:16px}
    .grid{display:grid; grid-template-columns:repeat(2,minmax(200px,1fr)); gap:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted)}
    input, select{background:#0f1218; color:var(--fg); border:1px solid var(--border); border-radius:12px; padding:10px 12px; outline:none}
    .seg{display:flex; background:#0f1218; border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .seg button{flex:1; border:none; background:transparent; color:var(--fg); padding:10px 12px; cursor:pointer; font-weight:700}
    .seg button.active{background:#222938}
    .result{font-size:20px; font-weight:800; margin-top:2px}
    @media (max-width: 640px){ .hide-sm{display:none} h1{font-size:18px} .container{padding:16px} .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Canlƒ± Piyasalar ‚Äî D√∂viz ‚Ä¢ Altƒ±n ‚Ä¢ D√∂n√º≈üt√ºr√ºc√º</h1>
          <div class="sub">Kaynak: workers.dev ‚Üí canlipiyasalar.haremaltin.com (JSON)</div>
        </div>
      </div>
      <div class="controls">
        <div class="tabs">
          <button id="tab-doviz" class="tab active">üí± D√∂viz</button>
          <button id="tab-altin" class="tab">üèÖ Altƒ±n & G√ºm√º≈ü</button>
          <button id="tab-conv" class="tab">üîÅ D√∂n√º≈üt√ºr√ºc√º</button>
        </div>
      </div>
    </header>

    <!-- D√∂viz -->
    <section id="view-doviz" class="card">
      <div class="meta">
        <span id="upd-doviz" class="badge">Son g√ºncelleme: ‚Äî</span>
        <span class="badge hide-sm">G√∂sterim: D√∂viz 3 hane</span>
      </div>
      <div style="overflow:auto; max-height:min(70vh, 900px)">
        <table id="tbl-doviz">
          <thead>
            <tr>
              <th>Kod</th>
              <th class="hide-sm">Tarih</th>
              <th style="text-align:right">Alƒ±≈ü</th>
              <th style="text-align:right">Satƒ±≈ü</th>
            </tr>
          </thead>
          <tbody id="tbody-doviz"></tbody>
        </table>
      </div>
      <div class="footer">
        <div>Not: Fiyatlar bilgilendirme ama√ßlƒ±dƒ±r.</div>
        <a class="link hide-sm" href="https://lingering-scene-da42.mehmetklc1907.workers.dev/" target="_blank" rel="noopener">JSON kaynaƒüƒ±</a>
      </div>
    </section>

    <!-- Altƒ±n -->
    <section id="view-altin" class="card hide">
      <div class="meta">
        <span id="upd-altin" class="badge">Son g√ºncelleme: ‚Äî</span>
        <span class="badge hide-sm">G√∂sterim: Altƒ±n & G√ºm√º≈ü 2 hane</span>
      </div>
      <div style="overflow:auto; max-height:min(70vh, 900px)">
        <table id="tbl-altin">
          <thead>
            <tr>
              <th>Kod</th>
              <th class="hide-sm">Tarih</th>
              <th style="text-align:right">Alƒ±≈ü</th>
              <th style="text-align:right">Satƒ±≈ü</th>
            </tr>
          </thead>
          <tbody id="tbody-altin"></tbody>
        </table>
      </div>
      <div class="footer">
        <div>Not: Fiyatlar bilgilendirme ama√ßlƒ±dƒ±r.</div>
        <a class="link hide-sm" href="https://lingering-scene-da42.mehmetklc1907.workers.dev/" target="_blank" rel="noopener">JSON kaynaƒüƒ±</a>
      </div>
    </section>

    <!-- D√∂n√º≈üt√ºr√ºc√º -->
    <section id="view-conv" class="card hide">
      <div class="meta">
        <span id="upd-conv" class="badge">Son g√ºncelleme: ‚Äî</span>
        <span class="badge hide-sm">Marj: Alƒ±≈ü ‚Üì ‚Ä¢ Satƒ±≈ü ‚Üë</span>
      </div>
      <div class="conv">
        <div class="grid">
          <div class="field">
            <label>√áift (D√∂viz)</label>
            <select id="fx-code"></select>
          </div>
          <div class="field">
            <label>Y√∂n</label>
            <select id="fx-dir">
              <option value="toTRY">D√∂viz ‚Üí TL</option>
              <option value="fromTRY">TL ‚Üí D√∂viz</option>
            </select>
          </div>
          <div class="field">
            <label>T√ºr</label>
            <div id="fx-side" class="seg">
              <button type="button" data-side="alis" class="active">Alƒ±≈ü</button>
              <button type="button" data-side="satis">Satƒ±≈ü</button>
            </div>
          </div>
          <div class="field">
            <label>Miktar</label>
            <input id="fx-amount" type="number" step="0.01" value="500" />
          </div>
          <div class="field">
            <label>Marj (%, alƒ±≈ü / satƒ±≈ü)</label>
            <div style="display:flex; gap:8px">
              <input id="fx-m-alis"  type="number" step="0.01" value="0.15" title="Alƒ±≈üta y√ºzde d√º≈ü√ºr (√∂r. 0.15)" />
              <input id="fx-m-satis" type="number" step="0.01" value="0.15" title="Satƒ±≈üta y√ºzde artƒ±r (√∂r. 0.15)" />
            </div>
          </div>
          <div class="field" style="grid-column:1/-1">
            <label>Sonu√ß</label>
            <div id="fx-result" class="result">‚Äî</div>
            <div id="fx-note" class="sub" style="margin-top:6px">‚Äî</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const ENDPOINT = "https://lingering-scene-da42.mehmetklc1907.workers.dev/";

    // Kod k√ºmeleri (√∂ncekinden)
    const DOVIZ_CODES = ["USDTRY","EURTRY","GBPTRY","CHFTRY","AUDTRY","CADTRY","SARTRY","DKKTRY","SEKTRY","NOKTRY","JPYTRY","EURUSD","USDJPY","USDCAD","USDCHF","GBPUSD","AUDUSD"];
    const ALTIN_CODES = ["ALTIN","KULCEALTIN","ONS","AYAR22","AYAR14","CEYREK_YENI","CEYREK_ESKI","YARIM_YENI","YARIM_ESKI","TEK_YENI","TEK_ESKI","ATA_YENI","ATA_ESKI","ATA5_YENI","ATA5_ESKI","GREMESE_YENI","GREMESE_ESKI","GUMUSTRY","GUMUSUSD","XAGUSD","XAUXAG","XPTUSD","XPDUSD","PLATIN","PALADYUM"];

    const fmt3 = new Intl.NumberFormat('tr-TR', { minimumFractionDigits:3, maximumFractionDigits:3 });
    const fmt2 = new Intl.NumberFormat('tr-TR', { minimumFractionDigits:2, maximumFractionDigits:2 });
    const fmtTRY = new Intl.NumberFormat('tr-TR', { style:'currency', currency:'TRY', minimumFractionDigits:2, maximumFractionDigits:2 });

    function toNum(v){
      if (v === null || v === undefined) return NaN;
      if (typeof v === 'number') return v;
      let s = String(v).trim();
      const lastDot = s.lastIndexOf('.');
      const lastComma = s.lastIndexOf(',');
      if (lastDot !== -1 && lastComma !== -1) {
        const dec = Math.max(lastDot, lastComma);
        s = s.replace(/[.,]/g,'');
        s = s.slice(0, dec) + '.' + s.slice(dec);
        return Number.parseFloat(s);
      }
      if (lastComma !== -1 && lastDot === -1) {
        s = s.replace(/\./g,'').replace(',', '.');
        return Number.parseFloat(s);
      }
      return Number.parseFloat(s.replace(/[^0-9.-]/g,''));
    }

    let RAW = {}; // { CODE: { alis, satis, tarih, ... } }

    // Sekmeler
    const tabD = document.getElementById('tab-doviz');
    const tabA = document.getElementById('tab-altin');
    const tabC = document.getElementById('tab-conv');
    const viewD = document.getElementById('view-doviz');
    const viewA = document.getElementById('view-altin');
    const viewC = document.getElementById('view-conv');

    function showTab(which){
      tabD.classList.toggle('active', which==='d');
      tabA.classList.toggle('active', which==='a');
      tabC.classList.toggle('active', which==='c');
      viewD.classList.toggle('hide', which!=='d');
      viewA.classList.toggle('hide', which!=='a');
      viewC.classList.toggle('hide', which!=='c');
    }
    tabD.onclick = ()=>showTab('d');
    tabA.onclick = ()=>showTab('a');
    tabC.onclick = ()=>showTab('c');

    // Tablolar
    function renderTable(codes, tbodyId, decimals){
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = '';
      const frag = document.createDocumentFragment();
      codes.forEach(code=>{
        const r = RAW[code];
        if (!r) return;
        const a = toNum(r.alis), s = toNum(r.satis);
        const da = decimals===3 ? fmt3.format(a) : fmt2.format(a);
        const ds = decimals===3 ? fmt3.format(s) : fmt2.format(s);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="name">${code}</td>
          <td class="hide-sm">${r.tarih || ''}</td>
          <td class="money">${da}</td>
          <td class="money">${ds}</td>`;
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    // D√∂n√º≈üt√ºr√ºc√º el'leri
    const updD = document.getElementById('upd-doviz');
    const updA = document.getElementById('upd-altin');
    const updC = document.getElementById('upd-conv');

    const fxCode = document.getElementById('fx-code');
    const fxDir  = document.getElementById('fx-dir');
    const fxSide = document.getElementById('fx-side');
    const fxAmt  = document.getElementById('fx-amount');
    const fxRes  = document.getElementById('fx-result');
    const fxNote = document.getElementById('fx-note');
    const fxMAl  = document.getElementById('fx-m-alis');
    const fxMSa  = document.getElementById('fx-m-satis');

    fxSide.addEventListener('click', (e)=>{
      if(e.target.tagName==='BUTTON'){
        fxSide.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        computeFX();
      }
    });
    [fxCode, fxDir, fxAmt, fxMAl, fxMSa].forEach(el=> el.addEventListener('input', computeFX));

    function fillFXSelect(){
      fxCode.innerHTML = '';
      DOVIZ_CODES.filter(c=>RAW[c]).forEach(c=>{
        const r = RAW[c];
        const opt = document.createElement('option');
        const a = fmt3.format(toNum(r.alis));
        const s = fmt3.format(toNum(r.satis));
        opt.value = c; opt.textContent = `${c} ‚Ä¢ Alƒ±≈ü ${a} / Satƒ±≈ü ${s}`;
        fxCode.appendChild(opt);
      });
    }

    function computeFX(){
      const code = fxCode.value;
      if(!code || !RAW[code]){ fxRes.textContent='‚Äî'; fxNote.textContent='‚Äî'; return; }

      const side = fxSide.querySelector('button.active').dataset.side; // 'alis' | 'satis'
      const dir  = fxDir.value; // 'toTRY' | 'fromTRY'
      const amt  = Number(fxAmt.value) || 0;

      const base = toNum(RAW[code][side]);
      // Marj y√ºzdesi
      const mAl = Math.max(0, Number(fxMAl.value)||0) / 100;
      const mSa = Math.max(0, Number(fxMSa.value)||0) / 100;
      const used = side==='alis' ? base*(1 - mAl) : base*(1 + mSa);

      let out, unit;
      if (dir==='toTRY'){ // D√∂viz -> TL
        out = amt * used; unit = '‚Ç∫';
        fxRes.textContent = fmtTRY.format(out);
      }else{ // TL -> D√∂viz
        out = amt / used; unit = code.replace('TRY','');
        fxRes.textContent = `${fmt3.format(out)} ${unit}`;
      }
      fxNote.textContent = `${code} ${side==='alis'?'alƒ±≈ü':'satƒ±≈ü'}: ${fmt3.format(base)} ‚Üí marjlƒ±: ${fmt3.format(used)} ‚Ä¢ Miktar: ${amt}`;
    }

    async function load(){
      try{
        const res = await fetch(ENDPOINT, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const root = await res.json(); // { meta, data:{...} }
        RAW = root?.data || {};
        const any = Object.values(RAW)[0];
        const updText = `Son g√ºncelleme: ${any?.tarih || '-'}`;
        updD.textContent = updText; updA.textContent = updText; updC.textContent = updText;

        renderTable(DOVIZ_CODES, 'tbody-doviz', 3);
        renderTable(ALTIN_CODES, 'tbody-altin', 2);

        fillFXSelect();
        computeFX();
      }catch(err){
        console.error(err);
      }
    }

    // Ba≈ülat
    showTab('d'); // D√∂viz ilk
    load();
    setInterval(load, 30_000); // 30 sn
  </script>
</body>
</html>
