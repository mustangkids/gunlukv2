<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CanlÄ± Piyasalar â€” Mobil</title>
<style>
  :root{
    --bg:#0b0c0f; --fg:#e6e9f2; --muted:#9aa3b2;
    --card:#12141a; --border:#1f2430; --brand:#f5bf3e;
    --ok:#22c55e; --bad:#ef4444;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
  .wrap{max-width:820px;margin:0 auto;padding:16px}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#373b44,#101214);position:relative;box-shadow:0 10px 26px #0006}
  .logo:after{content:"";position:absolute;inset:6px;border-radius:10px;background:linear-gradient(135deg,#f7e08f,#cba034)}
  h1{margin:0;font-size:18px;letter-spacing:.2px}
  .sub{font-size:12px;color:var(--muted)}
  .status{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:999px;background:var(--bad);box-shadow:0 0 0 1px var(--border)}
  .ok{background:var(--ok)!important}
  .btn{appearance:none;border:none;background:var(--card);color:var(--fg);padding:9px 12px;border-radius:12px;cursor:pointer;box-shadow:0 0 0 1px var(--border);font-weight:600}
  .btn.refresh{background:linear-gradient(135deg,#f5bf3e,#d09d16);color:#1a1205}


  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 14px 36px #0007;padding:12px}
  .list{display:grid;grid-template-columns:1fr;gap:10px}
  .row{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:14px;background:#0f1218;border:1px solid #141824}
  .row.compact{padding:10px}
  .left{display:flex;flex-direction:column;gap:4px}
  .code{font-weight:800;font-size:16px}
  .date,.mini{font-size:12px;color:var(--muted)}
  .right{text-align:right;display:flex;flex-direction:column;gap:4px;font-variant-numeric:tabular-nums}
  .buy{opacity:.9} .sell{opacity:1}
  .badge{font-size:12px;padding:6px 8px;border-radius:999px;background:#171a22;border:1px solid var(--border);color:var(--muted)}
  .meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}

  .conv{display:grid;grid-template-columns:1fr;gap:14px}
  .field{display:flex;flex-direction:column;gap:8px}
  label{font-size:14px;color:var(--muted)}
  input,select{background:#0f1218;color:var(--fg);border:1px solid var(--border);border-radius:14px;padding:14px 16px;outline:none;font-size:18px}
  .seg{display:flex;background:#0f1218;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .seg button{flex:1;border:none;background:transparent;color:var(--fg);padding:14px 16px;cursor:pointer;font-weight:800;font-size:16px}
  .seg button.active{background:#20283a}
  .result{font-size:26px;font-weight:900}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  @media (min-width:640px){ .conv{grid-template-columns:repeat(2,1fr)} }

  /* dropdown geniÅŸlik fix */
  #viewConv select{ min-width:200px; text-align:left; padding-left:8px; box-sizing:border-box }
  @media (max-width:520px){ #viewConv select{ min-width:unset; width:100% } }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>CanlÄ± Piyasalar â€” Mobil</h1>
          <div class="sub" id="lastUpdated">Son gÃ¼ncelleme: â€”</div>
        </div>
      </div>
      <div class="status"><span id="connDot" class="dot"></span><span id="connText">BaÄŸlantÄ± yok</span></div>
      <button id="btnRefresh" class="btn refresh">Yenile</button>
    </header>

    <!-- DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼ -->
    <section id="viewConv" class="card">

      <!-- Ãœst mini mÃ¼ÅŸteri listesi (TL marjlÄ±) -->
      <section id="custCard" class="card" style="margin-bottom:10px">
        <div class="meta">
          <span class="badge">MÃ¼ÅŸteriye sÃ¶ylenecek fiyatlar</span>
          <span class="badge">TL marj uygulanmÄ±ÅŸ (3 hane)</span>
        </div>
        <div id="listCust" class="list"></div>
      </section>

      <div class="conv">
        <div class="field">
          <label>DÃ¶viz</label>
          <select id="fxCode"></select>
        </div>
        <div class="field">
          <label>YÃ¶n</label>
          <select id="fxDir">
            <option value="toTRY">DÃ¶viz â†’ TL</option>
            <option value="fromTRY">TL â†’ DÃ¶viz</option>
          </select>
        </div>
        <div class="field">
          <label>TÃ¼r</label>
          <div id="fxSide" class="seg">
            <button type="button" data-side="buy" class="active">AlÄ±ÅŸ</button>
            <button type="button" data-side="sell">SatÄ±ÅŸ</button>
          </div>
        </div>
        <div class="field">
          <label>Miktar</label>
          <input id="fxAmt" type="number" step="0.01" value="500"/>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>SonuÃ§</label>
          <div id="fxOut" class="result">â€”</div>
        </div>
      </div>
    </section>
  </div>

<script>
  const ENDPOINT = "https://curly-mud-7bc7.mehmetklc1907.workers.dev/all";

  const fmt3  = new Intl.NumberFormat('tr-TR',{minimumFractionDigits:3,maximumFractionDigits:3});
  const fmt2  = new Intl.NumberFormat('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtTRY= new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',minimumFractionDigits:2,maximumFractionDigits:2});

  function flagFor(code){
    const c = String(code||'').toUpperCase();
    if (c.startsWith('USD')) return 'ðŸ‡ºðŸ‡¸';
    if (c.startsWith('EUR')) return 'ðŸ‡ªðŸ‡º';
    if (c.startsWith('GBP')) return 'ðŸ‡¬ðŸ‡§';
    if (c.startsWith('CHF')) return 'ðŸ‡¨ðŸ‡­';
    if (c.startsWith('TRY') || c.endsWith('TRY')) return 'ðŸ‡¹ðŸ‡·';
    return 'ðŸ’±';
  }

  const DISPLAY_NAMES = {
    USDTRY:"DOLAR", EURTRY:"EURO", GBPTRY:"STERLÄ°N", CHFTRY:"Ä°SVÄ°Ã‡RE FRANGI"
  };
  const NAME = c => DISPLAY_NAMES[c] || c;

  /* BaÄŸlantÄ± gÃ¶stergesi */
  const connDot = document.getElementById('connDot');
  const connText= document.getElementById('connText');
  const lastUpdated = document.getElementById('lastUpdated');
  function setConn(ok, tsText){
    connDot.classList.toggle('ok', !!ok);
    connText.textContent = ok ? 'BaÄŸlÄ±' : 'BaÄŸlantÄ± yok';
    if (tsText) lastUpdated.textContent = 'Son gÃ¼ncelleme: ' + tsText;
  }


  // Yeni API sadece 4 parite destekliyor
  const DOVIZ_CODES = ["USDTRY","EURTRY","GBPTRY","CHFTRY"];

  let RAW = {};

  async function load(){
    try{
      const res = await fetch(ENDPOINT, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      RAW = await res.json();

      // Zaman damgasÄ± yok, ÅŸu anki zamanÄ± gÃ¶ster
      const now = new Date();
      const tsText = now.toLocaleString('tr-TR');
      setConn(true, tsText);

      fillConverter(true);
      restoreConvState();
      renderCustConv();
      computeConv();
    }catch(e){ console.error(e); setConn(false); }
  }
  document.getElementById('btnRefresh').onclick = ()=> load();


  /* --- TL Marj (sabit) --- */
  const MARJ_TL = 0.300; // 30 kuruÅŸ

  function currentMarginTL(){
    return { mAlisTL: MARJ_TL, mSatisTL: MARJ_TL };
  }
  function adjustedTL(side, base, mAlisTL, mSatisTL){
    return side==='buy' ? (base - mAlisTL) : (base + mSatisTL);
  }

  /* Ãœst mini liste (DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼ sekmesi) */
  const listCust = document.getElementById('listCust');
  const CUST_CODES = ["USDTRY","EURTRY","GBPTRY","CHFTRY"];

  function makeCustRow(label, code, buy, sell){
    const div = document.createElement('div'); div.className='row compact';
    div.innerHTML = `
      <div class="left">
        <div class="code">${flagFor(code)} ${label}</div>
        <div class="mini">${code}</div>
      </div>
      <div class="right">
        <div class="buy">AlÄ±ÅŸ: <b>${fmt3.format(buy)}</b></div>
        <div class="sell">SatÄ±ÅŸ: <b>${fmt3.format(sell)}</b></div>
      </div>`;
    return div;
  }
  function renderCustConv(){
    listCust.innerHTML=''; if(!RAW || !Object.keys(RAW).length) return;
    const { mAlisTL, mSatisTL } = currentMarginTL();
    CUST_CODES.forEach(code=>{
      const r = RAW[code]; if(!r) return;
      const buy = adjustedTL('buy',  r.buy,  mAlisTL, mSatisTL);
      const sell = adjustedTL('sell', r.sell, mAlisTL, mSatisTL);
      listCust.appendChild(makeCustRow(NAME(code), code, buy, sell));
    });
  }

  /* DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼ */
  const fxCode = document.getElementById('fxCode');
  const fxDir  = document.getElementById('fxDir');
  const fxSide = document.getElementById('fxSide');
  const fxAmt  = document.getElementById('fxAmt');
  const fxOut  = document.getElementById('fxOut');

  function fillConverter(preserve = true){
    let prev = preserve ? (fxCode.value || (JSON.parse(localStorage.getItem('conv.state')||'{}').code)) : null;

    fxCode.innerHTML = '';
    DOVIZ_CODES.filter(c=>RAW[c]).forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = `${flagFor(c)} ${NAME(c)}`;
      fxCode.appendChild(opt);
    });

    if (prev && [...fxCode.options].some(o => o.value === prev)) {
      fxCode.value = prev;
    }
  }
  function readSide(){ return fxSide.querySelector('button.active').dataset.side; }
  function saveConvState(){
    const state = { code: fxCode.value, dir: fxDir.value, side: readSide(), amt: fxAmt.value };
    localStorage.setItem('conv.state', JSON.stringify(state));
  }
  function restoreConvState(){
    try{
      const s = JSON.parse(localStorage.getItem('conv.state')||'{}');
      if (s.code && [...fxCode.options].some(o=>o.value===s.code)) fxCode.value = s.code;
      if (s.dir)  fxDir.value = s.dir;
      if (s.amt)  fxAmt.value = s.amt;
      if (s.side){
        fxSide.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.side===s.side));
      }
    }catch{}
  }

  function computeConv(){
    const code = fxCode.value, dir = fxDir.value;
    const side = readSide();
    const amt  = Number(fxAmt.value)||0;
    const row = RAW[code];
    if(!row){ fxOut.textContent='â€”'; return; }

    const { mAlisTL, mSatisTL } = currentMarginTL();
    const base = row[side];
    const rate = adjustedTL(side, base, mAlisTL, mSatisTL);

    if (dir==='toTRY'){
      const val = amt * rate;
      fxOut.textContent = fmtTRY.format(val);
    }else{
      const val = amt / rate;
      fxOut.textContent = `${fmt3.format(val)} ${code.replace('TRY','')}`;
    }
  }

  fxCode.onchange = ()=>{ saveConvState(); computeConv(); };
  fxDir.onchange  = ()=>{ saveConvState(); computeConv(); };
  fxAmt.oninput   = ()=>{ saveConvState(); computeConv(); };
  fxSide.addEventListener('click',(e)=>{
    if(e.target.tagName==='BUTTON'){
      fxSide.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      saveConvState(); computeConv();
    }
  });
  function start(){
    load();
    setInterval(load, 62000);
  }
  start();
</script>
</body>
</html>
