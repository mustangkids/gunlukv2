<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Canlƒ± Piyasalar ‚Äî Mobil</title>
<style>
  :root{
    --bg:#0b0c0f; --fg:#e6e9f2; --muted:#9aa3b2;
    --card:#12141a; --border:#1f2430; --brand:#f5bf3e;
    --ok:#22c55e; --bad:#ef4444; --ink:#0f1218;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
  .wrap{max-width:820px;margin:0 auto;padding:16px}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#373b44,#101214);position:relative;box-shadow:0 10px 26px #0006}
  .logo:after{content:"";position:absolute;inset:6px;border-radius:10px;background:linear-gradient(135deg,#f7e08f,#cba034)}
  h1{margin:0;font-size:18px;letter-spacing:.2px}
  .sub{font-size:12px;color:var(--muted)}
  .header-right{display:flex;align-items:center;gap:10px}
  .status{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:999px;background:var(--bad);box-shadow:0 0 0 1px var(--border)}
  .ok{background:var(--ok)!important}
  .btn{appearance:none;border:none;background:var(--card);color:var(--fg);padding:9px 12px;border-radius:12px;cursor:pointer;box-shadow:0 0 0 1px var(--border);font-weight:600}
  .btn.refresh{background:linear-gradient(135deg,#f5bf3e,#d09d16);color:#1a1205}

  .tabs{display:flex;gap:8px;overflow:auto;padding:2px 0;margin-bottom:10px}
  .tab{border:none;background:#171a22;color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 0 0 1px var(--border);font-weight:700;white-space:nowrap}
  .tab.active{background:linear-gradient(135deg,#f5bf3e,#d09d16);color:#1a1205}

  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 14px 36px #0007;padding:12px}
  .list{display:grid;grid-template-columns:1fr;gap:10px}
  .row{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:14px;background:#0f1218;border:1px solid #141824}
  .left{display:flex;flex-direction:column;gap:4px}
  .code{font-weight:800;font-size:16px}
  .date{font-size:12px;color:var(--muted)}
  .right{text-align:right;display:flex;flex-direction:column;gap:4px;font-variant-numeric:tabular-nums}
  .buy{opacity:.9}
  .sell{opacity:1}
  .badge{font-size:12px;padding:6px 8px;border-radius:999px;background:#171a22;border:1px solid var(--border);color:var(--muted)}
  .meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}

  .conv{display:grid;grid-template-columns:1fr;gap:14px}
  .field{display:flex;flex-direction:column;gap:8px}
  label{font-size:14px;color:var(--muted)}
  input,select{background:#0f1218;color:var(--fg);border:1px solid var(--border);border-radius:14px;padding:14px 16px;outline:none;font-size:18px}
  .seg{display:flex;background:#0f1218;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .seg button{flex:1;border:none;background:transparent;color:var(--fg);padding:14px 16px;cursor:pointer;font-weight:800;font-size:16px}
  .seg button.active{background:#20283a}
  .result{font-size:26px;font-weight:900}
  .hint{color:var(--muted);font-size:13px}
  .hide{display:none !important}
  .tog{border:none;background:#171a22;color:var(--fg);padding:8px 12px;border-radius:999px;cursor:pointer;box-shadow:0 0 0 1px var(--border);font-weight:700}
  .tog.icon{width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;font-size:18px}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  @media (min-width:640px){ .conv{grid-template-columns:repeat(2,1fr)} }

  /* --- D√∂n√º≈üt√ºr√ºc√º dropdown geni≈ülik d√ºzeltmesi --- */
  #viewConv select{
    min-width: 200px;
    text-align: left;
    padding-left: 8px;
    box-sizing: border-box;
  }
  @media (max-width: 520px){
    #viewConv select{
      min-width: unset;
      width: 100%;
    }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Canlƒ± Piyasalar ‚Äî Mobil</h1>
          <div class="sub" id="lastUpdated">Son g√ºncelleme: ‚Äî</div>
        </div>
      </div>
      <div class="header-right">
        <div class="status"><span id="connDot" class="dot"></span><span id="connText">Baƒülantƒ± yok</span></div>
        <button id="btnRefresh" class="btn refresh">Yenile</button>
      </div>
    </header>

    <div class="tabs">
      <button id="tabFx" class="tab active">üí± D√∂viz</button>
      <button id="tabAu" class="tab">üèÖ Altƒ±n & G√ºm√º≈ü</button>
      <button id="tabConv" class="tab">üîÅ D√∂n√º≈üt√ºr√ºc√º</button>
    </div>

    <!-- D√∂viz -->
    <section id="viewFx" class="card">
      <div class="meta">
        <span class="badge">G√∂sterim: 3 hane</span>
        <span class="badge">Bilgilendirme ama√ßlƒ±</span>
      </div>
      <div id="listFx" class="list"></div>
    </section>

    <!-- Altƒ±n -->
    <section id="viewAu" class="card hide">
      <div class="meta">
        <span class="badge">G√∂sterim: 2 hane</span>
        <span class="badge">Bilgilendirme ama√ßlƒ±</span>
      </div>
      <div id="listAu" class="list"></div>
    </section>

    <!-- D√∂n√º≈üt√ºr√ºc√º -->
    <section id="viewConv" class="card hide">
      <div class="meta">
        <div class="flex">
          <span class="badge">ƒ∞ki y√∂n: D√∂viz‚ÜíTL / TL‚ÜíD√∂viz</span>
          <span id="marjState" class="badge">Marj: a√ßƒ±k ‚Ä¢ %0,247 / %0,247</span>
        </div>
        <!-- Sadece simge -->
        <button id="btnToggleMargin" class="tog icon" title="Marj ayarlarƒ±">‚öôÔ∏è</button>
      </div>

      <div class="conv">
        <div class="field">
          <label>D√∂viz</label>
          <select id="fxCode"></select>
        </div>
        <div class="field">
          <label>Y√∂n</label>
          <select id="fxDir">
            <option value="toTRY">D√∂viz ‚Üí TL</option>
            <option value="fromTRY">TL ‚Üí D√∂viz</option>
          </select>
        </div>
        <div class="field">
          <label>T√ºr</label>
          <div id="fxSide" class="seg">
            <button type="button" data-side="alis" class="active">Alƒ±≈ü</button>
            <button type="button" data-side="satis">Satƒ±≈ü</button>
          </div>
        </div>
        <div class="field">
          <label>Miktar</label>
          <input id="fxAmt" type="number" step="0.01" value="500"/>
        </div>

        <!-- Marj alanlarƒ±: varsayƒ±lan Gƒ∞ZLƒ∞. ‚öôÔ∏è ile a√ß/kapa -->
        <div id="marginBox" class="field hide" style="grid-column:1/-1">
          <label>Marj (%, alƒ±≈ü ‚Üì / satƒ±≈ü ‚Üë)</label>
          <div style="display:flex;gap:8px">
            <input id="mAlis"  type="number" step="0.01" value="0.247" title="Alƒ±≈üta y√ºzde d√º≈ü√ºr (√∂r. 0.247)"/>
            <input id="mSatis" type="number" step="0.01" value="0.247" title="Satƒ±≈üta y√ºzde artƒ±r (√∂r. 0.247)"/>
          </div>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>Sonu√ß</label>
          <div id="fxOut" class="result">‚Äî</div>
          <div id="fxNote" class="hint">‚Äî</div>
        </div>
      </div>
    </section>
  </div>

<script>
  const ENDPOINT = "https://lingering-scene-da42.mehmetklc1907.workers.dev/";

  const fmt3 = new Intl.NumberFormat('tr-TR',{minimumFractionDigits:3,maximumFractionDigits:3});
  const fmt2 = new Intl.NumberFormat('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtTRY = new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',minimumFractionDigits:2,maximumFractionDigits:2});

  function toNum(v){
    if (v === null || v === undefined) return NaN;
    if (typeof v === 'number') return v;
    let s = String(v).trim();
    const lastDot = s.lastIndexOf('.'), lastComma = s.lastIndexOf(',');
    if (lastDot !== -1 && lastComma !== -1){
      const dec = Math.max(lastDot,lastComma);
      s = s.replace(/[.,]/g,''); s = s.slice(0,dec)+'.'+s.slice(dec);
      return Number.parseFloat(s);
    }
    if (lastComma !== -1 && lastDot === -1){
      s = s.replace(/\./g,'').replace(',', '.'); return Number.parseFloat(s);
    }
    return Number.parseFloat(s.replace(/[^0-9.-]/g,''));
  }

  /* Bayrak + sembol */
  function flagFor(code){
    const c = String(code||'').toUpperCase();
    if (c.startsWith('USD')) return 'üá∫üá∏ $';
    if (c.startsWith('EUR')) return 'üá™üá∫ ‚Ç¨';
    if (c.startsWith('GBP')) return 'üá¨üáß ¬£';
    if (c.startsWith('JPY')) return 'üáØüáµ ¬•';
    if (c.startsWith('CHF')) return 'üá®üá≠ ‚Ç£';
    if (c.startsWith('AUD')) return 'üá¶üá∫ $';
    if (c.startsWith('CAD')) return 'üá®üá¶ $';
    if (c.startsWith('SAR')) return 'üá∏üá¶ ÿ±.ÿ≥';
    if (c.startsWith('DKK')) return 'üá©üá∞ kr';
    if (c.startsWith('SEK')) return 'üá∏üá™ kr';
    if (c.startsWith('NOK')) return 'üá≥üá¥ kr';
    if (c.startsWith('TRY') || c.endsWith('TRY')) return 'üáπüá∑ ‚Ç∫';
    return 'üí±';
  }

  /* D√∂n√º≈üt√ºr√ºc√ºde okunabilir isimler */
  const DISPLAY_NAMES = {
    USDTRY: "DOLAR",
    EURTRY: "EURO",
    GBPTRY: "STERLƒ∞N",
    CHFTRY: "ƒ∞SVƒ∞√áRE FRANGI",
    AUDTRY: "AVUSTRALYA DOLARI",
    CADTRY: "KANADA DOLARI",
    SARTRY: "SUUDƒ∞ ARABƒ∞STAN Rƒ∞YALƒ∞",
    DKKTRY: "DANƒ∞MARKA KRONU",
    SEKTRY: "ƒ∞SVE√á KRONU",
    NOKTRY: "NORVE√á KRONU",
    JPYTRY: "JAPON YENƒ∞"
  };
  function nameFor(code){ return DISPLAY_NAMES[code] || code; }

  /* Durum UI */
  const connDot = document.getElementById('connDot');
  const connText = document.getElementById('connText');
  const lastUpdated = document.getElementById('lastUpdated');
  function setConn(ok, tsText){
    connDot.classList.toggle('ok', !!ok);
    connText.textContent = ok ? 'Baƒülƒ±' : 'Baƒülantƒ± yok';
    if (tsText) lastUpdated.textContent = 'Son g√ºncelleme: ' + tsText;
  }

  const viewFx = document.getElementById('viewFx');
  const viewAu = document.getElementById('viewAu');
  const viewConv = document.getElementById('viewConv');
  document.getElementById('tabFx').onclick = ()=>show('fx');
  document.getElementById('tabAu').onclick = ()=>show('au');
  document.getElementById('tabConv').onclick = ()=>show('conv');
  function show(which){
    document.getElementById('tabFx').classList.toggle('active', which==='fx');
    document.getElementById('tabAu').classList.toggle('active', which==='au');
    document.getElementById('tabConv').classList.toggle('active', which==='conv');
    viewFx.classList.toggle('hide', which!=='fx');
    viewAu.classList.toggle('hide', which!=='au');
    viewConv.classList.toggle('hide', which!=='conv');
  }

  const DOVIZ_CODES = ["USDTRY","EURTRY","GBPTRY","CHFTRY","AUDTRY","CADTRY","SARTRY","DKKTRY","SEKTRY","NOKTRY","JPYTRY","EURUSD","USDJPY","USDCAD","USDCHF","GBPUSD","AUDUSD"];
  const ALTIN_CODES = ["ALTIN","KULCEALTIN","ONS","AYAR22","AYAR14","CEYREK_YENI","CEYREK_ESKI","YARIM_YENI","YARIM_ESKI","TEK_YENI","TEK_ESKI","ATA_YENI","ATA_ESKI","ATA5_YENI","ATA5_ESKI","GREMESE_YENI","GREMESE_ESKI","GUMUSTRY","GUMUSUSD","XAGUSD","XAUXAG","XPTUSD","XPDUSD","PLATIN","PALADYUM"];

  let RAW = {}; // { CODE: { alis, satis, tarih } }

  async function load(){
    try{
      const res = await fetch(ENDPOINT, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const root = await res.json();
      RAW = root?.data || {};
      const any = Object.values(RAW)[0];
      const tsText = any?.tarih || '‚Äî';
      setConn(true, tsText);
      renderFx(); renderAu();
      fillConverter(); computeConv();
    }catch(err){
      console.error(err);
      setConn(false);
    }
  }
  document.getElementById('btnRefresh').onclick = ()=> load();

  const listFx = document.getElementById('listFx');
  const listAu = document.getElementById('listAu');

  function makeRow(code, a, s, date, decimals){
    const aT = (decimals===3?fmt3:fmt2).format(a);
    const sT = (decimals===3?fmt3:fmt2).format(s);
    const div = document.createElement('div'); div.className = 'row';
    div.innerHTML = `
      <div class="left">
        <div class="code">${flagFor(code)} ${code}</div>
        <div class="date">${date||''}</div>
      </div>
      <div class="right">
        <div class="buy">Alƒ±≈ü: <b>${aT}</b></div>
        <div class="sell">Satƒ±≈ü: <b>${sT}</b></div>
      </div>`;
    return div;
  }
  function renderFx(){
    listFx.innerHTML = '';
    DOVIZ_CODES.forEach(code=>{
      const r = RAW[code]; if(!r) return;
      listFx.appendChild(makeRow(code, toNum(r.alis), toNum(r.satis), r.tarih, 3));
    });
  }
  function renderAu(){
    listAu.innerHTML = '';
    ALTIN_CODES.forEach(code=>{
      const r = RAW[code]; if(!r) return;
      listAu.appendChild(makeRow(code, toNum(r.alis), toNum(r.satis), r.tarih, 2));
    });
  }

  /* D√∂n√º≈üt√ºr√ºc√º */
  const fxCode = document.getElementById('fxCode');
  const fxDir  = document.getElementById('fxDir');
  const fxSide = document.getElementById('fxSide');
  const fxAmt  = document.getElementById('fxAmt');
  const fxOut  = document.getElementById('fxOut');
  const fxNote = document.getElementById('fxNote');
  const btnToggleMargin = document.getElementById('btnToggleMargin');
  const marginBox = document.getElementById('marginBox');
  const marjState = document.getElementById('marjState');

  function fillConverter(){
    fxCode.innerHTML = '';
    DOVIZ_CODES.filter(c=>RAW[c]).forEach(c=>{
      const r = RAW[c];
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = `${flagFor(c)} ${nameFor(c)} ‚Ä¢ Alƒ±≈ü ${fmt3.format(toNum(r.alis))} / Satƒ±≈ü ${fmt3.format(toNum(r.satis))}`;
      fxCode.appendChild(opt);
    });
  }

  // Marj: Varsayƒ±lan A√áIK (UI gizli). Otomatik deƒüer %0,247.
  let useMargin = true;
  function pct(v){ return Math.max(0, Number(v)||0)/100; }
  function adjusted(side, base, mAlisPct, mSatisPct){
    if(!useMargin) return base;
    return side==='alis' ? base*(1 - mAlisPct) : base*(1 + mSatisPct);
    // alƒ±≈üta d√º≈ü√ºr, satƒ±≈üta artƒ±r
  }

  btnToggleMargin.onclick = ()=>{
    const wasHidden = marginBox.classList.contains('hide');
    marginBox.classList.toggle('hide', !wasHidden ? true : false);
    btnToggleMargin.title = marginBox.classList.contains('hide') ? 'Marj ayarlarƒ±nƒ± g√∂ster' : 'Marj ayarlarƒ±nƒ± gizle';
  };

  fxCode.onchange = computeConv;
  fxDir.onchange  = computeConv;
  fxAmt.oninput   = computeConv;
  fxSide.addEventListener('click',(e)=>{
    if(e.target.tagName==='BUTTON'){
      fxSide.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active'); computeConv();
    }
  });
  document.getElementById('mAlis')?.addEventListener('input', computeConv);
  document.getElementById('mSatis')?.addEventListener('input', computeConv);

  function computeConv(){
    const code = fxCode.value;
    const dir  = fxDir.value;
    const side = fxSide.querySelector('button.active').dataset.side; // 'alis' | 'satis'
    const amt  = Number(fxAmt.value) || 0;
    const row  = RAW[code];
    if(!row){ fxOut.textContent='‚Äî'; fxNote.textContent='‚Äî'; return; }

    // Otomatik (gizliyse) %0,247; UI a√ßƒ±ksa oradan al
    const auto = 0.00247;
    const mAlisPct  = marginBox.classList.contains('hide') ? auto : pct(document.getElementById('mAlis').value);
    const mSatisPct = marginBox.classList.contains('hide') ? auto : pct(document.getElementById('mSatis').value);
    marjState.textContent = `Marj: ${useMargin?'a√ßƒ±k':'kapalƒ±'} ‚Ä¢ ${(mAlisPct*100).toFixed(3)}% / ${(mSatisPct*100).toFixed(3)}%`;

    const base = toNum(row[side]);
    const rate = adjusted(side, base, mAlisPct, mSatisPct);

    if (dir==='toTRY'){
      const val = amt * rate;
      fxOut.textContent = fmtTRY.format(val);
      fxNote.textContent = `${flagFor(code)} ${nameFor(code)} (${code}) ${side==='alis'?'alƒ±≈ü':'satƒ±≈ü'}: ${fmt3.format(base)} ‚Üí kullanƒ±lan: ${fmt3.format(rate)} ‚Ä¢ miktar: ${amt}`;
    }else{
      const val = amt / rate;
      fxOut.textContent = `${fmt3.format(val)} ${code.replace('TRY','')}`;
      fxNote.textContent = `${flagFor(code)} ${nameFor(code)} (${code}) ${side==='alis'?'alƒ±≈ü':'satƒ±≈ü'}: ${fmt3.format(base)} ‚Üí kullanƒ±lan: ${fmt3.format(rate)} ‚Ä¢ miktar: ${amt} ‚Ç∫`;
    }
  }

  function start(){
    show('fx');
    marginBox.classList.add('hide');           // marj UI gizli
    btnToggleMargin.title = 'Marj ayarlarƒ±nƒ± g√∂ster';
    load();
    setInterval(load, 30000);
  }
  start();
</script>
</body>
</html>
