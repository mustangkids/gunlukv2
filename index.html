<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Canlƒ± Piyasalar ‚Äî D√∂viz ‚Ä¢ Altƒ±n ‚Ä¢ D√∂n√º≈üt√ºr√ºc√º</title>
  <style>
    :root{
      --bg: #0b0c0f; --card: #12141a; --muted: #8b93a7; --fg: #e6e9f2; --brand: #f5bf3e; --border: #1f2430;
      --ok:#22c55e; --accent:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--fg);}
    .container{max-width:1000px; margin:0 auto; padding:16px;}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:12px}
    .title{display:flex; align-items:center; gap:12px}
    .logo{width:34px; height:34px; border-radius:10px; background:linear-gradient(135deg, #373b44, #0f0f10); position:relative; box-shadow:0 8px 24px #00000055}
    .logo::after{content:""; position:absolute; inset:6px; border-radius:8px; background:linear-gradient(135deg, #f7e08f, #caa33a);}
    h1{font-size:20px; margin:0}
    .sub{font-size:12px; color:var(--muted)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{appearance:none; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; background:#171a22; color:var(--fg); box-shadow:0 0 0 1px var(--border); font-weight:700}
    .tab.active{background:linear-gradient(135deg,#f5bf3e,#d09d16); color:#1a1205}
    .badge{font-size:12px; padding:6px 8px; border-radius:999px; background:#171a22; border:1px solid var(--border); color:var(--muted)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 40px #00000055; overflow:hidden; margin-top:10px}
    .meta{display:flex; gap:12px; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border)}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{font-size:12px; color:var(--muted); text-align:left; padding:12px 14px; position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border);}
    tbody td{padding:14px; border-bottom:1px solid var(--border);}
    tbody tr:hover{background:#141821}
    .name{font-weight:600}
    .unit{color:var(--muted); font-size:12px}
    .money{font-variant-numeric: tabular-nums; text-align:right}
    .footer{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; font-size:12px; color:var(--muted)}
    .hide{display:none !important}
    .controls{display:flex; gap:12px; flex-wrap:wrap; align-items:end; padding:12px 16px}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted)}
    input, select{background:#0f1218; color:var(--fg); border:1px solid var(--border); border-radius:12px; padding:10px 12px; outline:none; min-width:140px}
    .seg{display:flex; background:#0f1218; border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .seg button{flex:1; border:none; background:transparent; color:var(--fg); padding:10px 12px; cursor:pointer; font-weight:700}
    .seg button.active{background:#222938}
    .result{font-size:20px; font-weight:800; color:#e6e9f2}
    .muted{color:var(--muted)}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; background:#171a22; border:1px solid var(--border); font-size:12px}
    a.link{color:var(--fg); opacity:.8; text-decoration:none}
    a.link:hover{opacity:1}
    @media (max-width: 640px){
      .container{padding:12px}
      h1{font-size:18px}
      .hide-sm{display:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Canlƒ± Piyasalar ‚Äî D√∂viz ‚Ä¢ Altƒ±n ‚Ä¢ D√∂n√º≈üt√ºr√ºc√º</h1>
          <div class="sub">Kaynak: Cloudflare Worker ‚Üí Harem JSON</div>
        </div>
      </div>
      <div class="tabs">
        <button id="tab-doviz" class="tab active">üí± D√∂viz</button>
        <button id="tab-altin" class="tab">üèÖ Altƒ±n & G√ºm√º≈ü</button>
        <button id="tab-donus" class="tab">üîÅ D√∂n√º≈üt√ºr√ºc√º</button>
      </div>
    </header>

    <!-- D√∂viz Tab -->
    <section id="view-doviz" class="card">
      <div class="meta">
        <span id="upd-doviz" class="badge">Son g√ºncelleme: ‚Äî</span>
        <span class="badge hide-sm">G√∂sterim: D√∂viz 3 hane</span>
      </div>
      <div style="overflow:auto; max-height:min(70vh, 900px)">
        <table>
          <thead>
            <tr>
              <th>Kod</th>
              <th class="hide-sm">Tarih</th>
              <th style="text-align:right">Alƒ±≈ü</th>
              <th style="text-align:right">Satƒ±≈ü</th>
            </tr>
          </thead>
          <tbody id="tbody-doviz"></tbody>
        </table>
      </div>
      <div class="footer">
        <div>Not: Fiyatlar bilgilendirme ama√ßlƒ±dƒ±r.</div>
        <a class="link hide-sm" href="https://lingering-scene-da42.mehmetklc1907.workers.dev/" target="_blank" rel="noopener">JSON</a>
      </div>
    </section>

    <!-- Altƒ±n Tab -->
    <section id="view-altin" class="card hide">
      <div class="meta">
        <span id="upd-altin" class="badge">Son g√ºncelleme: ‚Äî</span>
        <span class="badge hide-sm">G√∂sterim: Altƒ±n & G√ºm√º≈ü 2 hane</span>
      </div>
      <div style="overflow:auto; max-height:min(70vh, 900px)">
        <table>
          <thead>
            <tr>
              <th>Kod</th>
              <th class="hide-sm">Tarih</th>
              <th style="text-align:right">Alƒ±≈ü</th>
              <th style="text-align:right">Satƒ±≈ü</th>
            </tr>
          </thead>
          <tbody id="tbody-altin"></tbody>
        </table>
      </div>
      <div class="footer">
        <div>Not: Fiyatlar bilgilendirme ama√ßlƒ±dƒ±r.</div>
        <a class="link hide-sm" href="https://lingering-scene-da42.mehmetklc1907.workers.dev/" target="_blank" rel="noopener">JSON</a>
      </div>
    </section>

    <!-- D√∂n√º≈üt√ºr√ºc√º Tab -->
    <section id="view-donus" class="card hide">
      <div class="meta">
        <span id="upd-donus" class="badge">Son g√ºncelleme: ‚Äî</span>
        <span class="badge">Marj: Alƒ±≈ü ‚Üì, Satƒ±≈ü ‚Üë</span>
      </div>
      <div class="controls">
        <div class="field">
          <label>√áift (D√∂viz)</label>
          <select id="fx-code"></select>
        </div>
        <div class="field">
          <label>Y√∂n</label>
          <select id="fx-dir">
            <option value="toTRY">D√∂viz ‚Üí TL</option>
            <option value="fromTRY">TL ‚Üí D√∂viz</option>
          </select>
        </div>
        <div class="field">
          <label>T√ºr</label>
          <div id="fx-side" class="seg">
            <button type="button" data-side="alis" class="active">Alƒ±≈ü</button>
            <button type="button" data-side="satis">Satƒ±≈ü</button>
          </div>
        </div>
        <div class="field">
          <label>Miktar</label>
          <input id="fx-amount" type="number" step="0.01" value="500" />
        </div>
        <div class="field">
          <label>Marj (%, alƒ±≈ü / satƒ±≈ü)</label>
          <div style="display:flex; gap:8px">
            <input id="fx-m-alis" type="number" step="0.01" value="0.15" title="Alƒ±≈üta y√ºzde d√º≈ü√ºr (√∂rn 0.15)" />
            <input id="fx-m-satis" type="number" step="0.01" value="0.15" title="Satƒ±≈üta y√ºzde artƒ±r (√∂rn 0.15)" />
          </div>
        </div>
        <div class="field" style="min-width:260px">
          <label>Sonu√ß</label>
          <div id="fx-result" class="result">‚Äî</div>
          <div id="fx-note" class="muted">‚Äî</div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const ENDPOINT = "https://lingering-scene-da42.mehmetklc1907.workers.dev/";
    // K√ºmeler (√∂ncekinden)
    const DOVIZ_CODES = ["USDTRY","EURTRY","GBPTRY","CHFTRY","AUDTRY","CADTRY","SARTRY","DKKTRY","SEKTRY","NOKTRY","JPYTRY","EURUSD","USDJPY","USDCAD","USDCHF","GBPUSD","AUDUSD"];
    const ALTIN_CODES = ["ALTIN","KULCEALTIN","ONS","AYAR22","AYAR14","CEYREK_YENI","CEYREK_ESKI","YARIM_YENI","YARIM_ESKI","TEK_YENI","TEK_ESKI","ATA_YENI","ATA_ESKI","ATA5_YENI","ATA5_ESKI","GREMESE_YENI","GREMESE_ESKI","GUMUSTRY","GUMUSUSD","XAGUSD","XAUXAG","XPTUSD","XPDUSD","PLATIN","PALADYUM"];

    const fmt3 = new Intl.NumberFormat('tr-TR',{minimumFractionDigits:3, maximumFractionDigits:3});
    const fmt2 = new Intl.NumberFormat('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2});
    const fmtTRY = new Intl.NumberFormat('tr-TR',{style:'currency', currency:'TRY', minimumFractionDigits:2, maximumFractionDigits:2});

    function toNum(v){
      if (v === null || v === undefined) return NaN;
      if (typeof v === 'number') return v;
      let s = String(v).trim();
      const lastDot = s.lastIndexOf('.');
      const lastComma = s.lastIndexOf(',');
      if (lastDot !== -1 && lastComma !== -1) {
        const dec = Math.max(lastDot,lastComma);
        s = s.replace(/[.,]/g,'');
        s = s.slice(0,dec)+'.'+s.slice(dec);
        return Number.parseFloat(s);
      }
      if (lastComma !== -1 && lastDot === -1) {
        s = s.replace(/\./g,'').replace(',', '.');
        return Number.parseFloat(s);
      }
      return Number.parseFloat(s.replace(/[^0-9.-]/g,''));
    }

    let RAW = {}; // { code: {...} }

    // Sekme ge√ßi≈üleri
    const vDoviz = document.getElementById('view-doviz');
    const vAltin = document.getElementById('view-altin');
    const vDonus = document.getElementById('view-donus');
    function showTab(name){
      document.getElementById('tab-doviz').classList.toggle('active', name==='doviz');
      document.getElementById('tab-altin').classList.toggle('active', name==='altin');
      document.getElementById('tab-donus').classList.toggle('active', name==='donus');
      vDoviz.classList.toggle('hide', name!=='doviz');
      vAltin.classList.toggle('hide', name!=='altin');
      vDonus.classList.toggle('hide', name!=='donus');
    }
    document.getElementById('tab-doviz').onclick = ()=>showTab('doviz');
    document.getElementById('tab-altin').onclick = ()=>showTab('altin');
    document.getElementById('tab-donus').onclick = ()=>showTab('donus');

    // Tablolar
    function renderTable(codes, tbodyId, decimals){
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = '';
      const frag = document.createDocumentFragment();
      codes.forEach(code=>{
        const r = RAW[code];
        if(!r) return;
        const al = toNum(r.alis), sa = toNum(r.satis);
        const dAl = decimals===3 ? fmt3.format(al) : fmt2.format(al);
        const dSa = decimals===3 ? fmt3.format(sa) : fmt2.format(sa);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="name">${code}</td>
          <td class="hide-sm">${r.tarih || ''}</td>
          <td class="money">${dAl}</td>
          <td class="money">${dSa}</td>`;
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    // D√∂n√º≈üt√ºr√ºc√º
    const fxCode = document.getElementById('fx-code');
    const fxDir = document.getElementById('fx-dir');
    const fxSideSeg = document.getElementById('fx-side');
    const fxAmount = document.getElementById('fx-amount');
    const fxRes = document.getElementById('fx-result');
    const fxNote = document.getElementById('fx-note');
    const updDoviz = document.getElementById('upd-doviz');
    const updAltin = document.getElementById('upd-altin');
    const updDonus = document.getElementById('upd-donus');
    const mAlis = document.getElementById('fx-m-alis');
    const mSatis = document.getElementById('fx-m-satis');

    fxSideSeg.addEventListener('click', (e)=>{
      if(e.target.tagName==='BUTTON'){
        fxSideSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        computeFX();
      }
    });
    fxDir.onchange = computeFX;
    fxAmount.oninput = computeFX;
    mAlis.oninput = computeFX;
    mSatis.oninput = computeFX;
    fxCode.onchange = computeFX;

    function fillFXSelect(){
      fxCode.innerHTML = '';
      DOVIZ_CODES.filter(c=>RAW[c]).forEach(c=>{
        const r = RAW[c];
        const opt = document.createElement('option');
        const a = fmt3.format(toNum(r.alis));
        const s = fmt3.format(toNum(r.satis));
        opt.value = c; opt.textContent = `${c} ‚Ä¢ Alƒ±≈ü ${a} / Satƒ±≈ü ${s}`;
        fxCode.appendChild(opt);
      });
    }

    function computeFX(){
      const code = fxCode.value;
      const side = fxSideSeg.querySelector('button.active').dataset.side; // 'alis' | 'satis'
      const dir = fxDir.value; // 'toTRY' | 'fromTRY'
      const amt = Number(fxAmount.value) || 0;
      const row = RAW[code];
      if(!row){ fxRes.textContent='‚Äî'; fxNote.textContent='‚Äî'; return; }

      // Marj (y√ºzde): alƒ±≈üta d√º≈ü√ºr, satƒ±≈üta artƒ±r
      const malis = Math.max(0, Number(mAlis.value)||0)/100;
      const msatis = Math.max(0, Number(mSatis.value)||0)/100;

      const base = toNum(row[side]);
      const used = side==='alis' ? base*(1 - malis) : base*(1 + msatis);

      let result, unit;
      if (dir==='toTRY'){ // D√∂viz -> TL
        result = amt * used;
        unit = '‚Ç∫';
      }else{ // TL -> D√∂viz
        result = amt / used;
        unit = code.replace('TRY','');
      }

      fxRes.textContent = dir==='toTRY' ? fmtTRY.format(result) : `${fmt3.format(result)} ${unit}`;
      fxNote.textContent = `${code} ${side==='alis'?'alƒ±≈ü':'satƒ±≈ü'}: ${fmt3.format(base)} ‚Üí marjlƒ±: ${fmt3.format(used)} ‚Ä¢ Miktar: ${amt}`;
    }

    async function load(){
      try{
        const res = await fetch(ENDPOINT, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const root = await res.json(); // { meta, data:{...} }
        RAW = root?.data || {};
        const any = Object.values(RAW)[0];
        const upd = `Son g√ºncelleme: ${any?.tarih || '-'}`;
        updDoviz.textContent = upd;
        updAltin.textContent = upd;
        updDonus.textContent = upd;

        // Tablolar
        renderTable(DOVIZ_CODES, 'tbody-doviz', 3);
        renderTable(ALTIN_CODES, 'tbody-altin', 2);

        // D√∂n√º≈üt√ºr√ºc√º
        fillFXSelect();
        computeFX();
      }catch(e){
        console.error(e);
      }
    }

    // Ba≈ülat
    showTab('doviz');
    load();
    setInterval(load, 30_000);
  </script>
</body>
</html>
